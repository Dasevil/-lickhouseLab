# Аналитическая записка по работе с MongoDB

## Введение

Данная записка представляет собой итоговый документ по лабораторной работе №3, посвященной работе с документо-ориентированной СУБД MongoDB. Целью работы было освоение проектирования иерархических структур данных, загрузка данных, создание индексов и выполнение аналитических запросов.

## Этапы выполнения работы

### 1. Подготовительный этап

На первом этапе была развернута инфраструктура с использованием Docker:
- MongoDB 7.x была добавлена в существующий `docker-compose.yml` файл
- Были установлены необходимые Python библиотеки: `pymongo`, `pandas`, `pyarrow`
- Подготовлены данные из файла `ozon_inference_2025_10_17_offers_2025_10_17.pq`

### 2. Проектирование и загрузка данных

#### Анализ исходных данных

Был проведен всесторонний анализ исходных данных:
- Уникальных категорий: 5261
- Максимальная глубина вложенности категорий: 8 уровней
- Топ-5 категорий по количеству товаров:
  - Строительство и ремонт\Инструменты для ремонта и строительства\Пневмоинструменты\Пневмогайковерты: 300 товаров
  - Строительство и ремонт\Инструменты для ремонта и строительства\Пневмоинструменты\Прочие пневмоинструменты: 300 товаров
  - Строительство и ремонт\Инструменты для ремонта и строительства\Пневмоинструменты\Аксессуары и оснастка для пневмоинструментов: 300 товаров
  - Строительство и ремонт\Инструменты для ремонта и строительства\Пневмоинструменты\Шланги воздушные для компрессора: 300 товаров
  - Строительство и ремонт\Инструменты для ремонта и строительства\Малярные и отделочные инструменты\Шпатели: 300 товаров
- Количество товаров с одинаковыми Offer_ID у разных партнеров: 0
- Уникальных типов товаров (Offer_Type): 12379

#### Обоснование схемы данных

Для хранения данных было принято решение о создании двух коллекций: `categories` и `products`. Это обусловлено следующими причинами:
1. **Нормализация данных**: информация о категории (название, путь, уровень) дублируется для каждого товара в категории. Выделение в отдельную коллекцию позволяет избежать избыточного хранения.
2. **Независимость обновлений**: метаданные категорий можно обновлять независимо от товаров.
3. **Гибкость запросов**: отдельная коллекция категорий позволяет эффективно выполнять иерархические запросы.
4. **Эффективность индексации**: индексы можно оптимизировать под специфические типы запросов.

#### Денормализация данных

В коллекции `products` была применена денормализация: информация о категории дублируется в виде вложенного документа `category`. Это имеет следующие преимущества:
1. **Производительность**: получение полной информации о товаре и его категории одним запросом без JOIN операций.
2. **Упрощение запросов**: клиентское приложение отображает информацию о категории без дополнительных запросов.
3. **Снижение нагрузки на БД**: отсутствие необходимости в соединениях уменьшает нагрузку.
4. **Масштабируемость**: документо-ориентированная модель с денормализацией лучше масштабируется.

### 3. Базовые запросы к иерархическим данным

#### Запросы к коллекции категорий

**Запрос 1: Корневые категории для _ozon**
- Результат: 0 документов
- Причина: партнер `_ozon` не является корневым уровнем. Все категории начинаются с более высоких уровней.
- Используемый индекс: `partner_level_index`

**Запрос 2: Подкатегории "Строительство и ремонт"**
- Результат: 539 документов
- Топ-3 результата:
  - Строительство и ремонт\Вентиляция\Вентиляторы и дефлекторы вентиляционные\Вентилятор приточно-вытяжной
  - Строительство и ремонт\Вентиляция\Вентиляторы и дефлекторы вентиляционные\Вентиляторы вытяжные
  - Строительство и ремонт\Вентиляция\Вентиляторы и дефлекторы вентиляционные\Вентиляторы канальные
- Используемый индекс: `path_array_index`

**Запрос 3: Топ-10 самых "населенных" категорий**
- Результат: 10 документов
- Топ-3 результата:
  - Строительство и ремонт\Инструменты для ремонта и строительства\Пневмоинструменты\Пневмогайковерты: 300 товаров
  - Строительство и ремонт\Инструменты для ремонта и строительства\Малярные и отделочные инструменты\Формы и трафареты: 300 товаров
  - Строительство и ремонт\Инструменты для ремонта и строительства\Слесарные инструменты\Щетки строительные: 300 товаров
- Используемый индекс: `total_products_index`

#### Запросы к коллекции товаров

**Запрос 4: Товары типа "Степлер строительный" с категорией "Пневмоинструменты"**
- Результат: 0 документов
- Причина: отсутствуют товары с таким типом в указанной категории.
- Используемый индекс: `breadcrumbs_name_index`

**Запрос 5: Товары на 4-м уровне иерархии**
- Результат: 0 документов
- Причина: в данных отсутствуют товары с ровно 4 уровнями в иерархии категорий.
- Используемый индекс: `COLLSCAN` (полное сканирование коллекции, так как индекса на поле `breadcrumbs` с оператором `$size` не существует)

**Запрос 6: Распределение товаров по категориям 1-го уровня**
- Результат: 5232 групп
- Топ-5 категорий:
  - Строительство и ремонт\Силовая техника и оборудование\Частотные преобразователи: 300 товаров
  - Электроника\Наушники и аудиотехника\Диктофоны: 300 товаров
  - Строительство и ремонт\Строительные материалы\Изоляционные покрытия и материалы\Теплоизоляция: 300 товаров
  - Автотовары\Шины и диски\Заглушки для дисков: 300 товаров
  - Туризм, рыбалка, охота\Туризм и отдых на природе\Аксессуары для туризма: 300 товаров
- Используемый оператор: агрегационный фреймворк с `$group` и `$arrayElemAt`

### 4. Агрегационный фреймворк

#### Задание 3.1: Аналитика по категориям

**Агрегация 1: Топ-10 категорий по количеству товаров с детальной статистикой**
- Результат: 10 документов
- Топ-3 результата:
  - Обувь\Детская обувь\Обувь для девочек\Дутики, угги и валенки для девочек: 300 товаров
  - Одежда\Женская одежда\Нижнее белье женское\Майки и топы бельевые женские: 300 товаров
  - Красота и здоровье\Уход за волосами\Шампуни и кондиционеры\Сухие и твердые шампуни для волос: 300 товаров
- Интерпретация: Самая большая категория по количеству товаров - Обувь\Детская обувь\Обувь для девочек\Дутики, угги и валенки для девочек с 300 товарами

**Агрегация 2: Иерархическая статистика по уровням**
- Результат: 30 документов
- Топ 3 на 1-м уровне:
  1. Хобби и творчество\Лепка и скульптура\Наборы для создания слепков: 300 товаров
  2. Бытовая химия и гигиена\Личная гигиена\Ватно-бумажная продукция\Туалетная бумага: 300 товаров
  3. Автотовары\Запчасти для легковых автомобилей\Кузовные запчасти\Детали багажника: 300 товаров
- Интерпретация: Больше всего товаров на уровне 1, наиболее представлены категории с товарами массового спроса

#### Задание 3.3: Анализ структуры категорий

**Агрегация А: Распределение категорий по уровням и партнерам**
- Результат: 1 документ
- Статистика:
  - Партнер: __ozon, Уровень: 1, Количество категорий: 5261, Сумма товаров: 1355049
- Средняя глубина категорий: 1.00 уровня

**Агрегация Б: Категории-листья**
- Результат: 10 документов
- Топ-3 категорий-листьев:
  - Строительство и ремонт\Инструменты для ремонта и строительства\Монтажные и крепежные инструменты\Пистолеты для герметиков: 300 товаров
  - Строительство и ремонт\Инструменты для ремонта и строительства\Малярные и отделочные инструменты\Валики и малярные ванночки: 300 товаров
  - Строительство и ремонт\Инструменты для ремонта и строительства\Монтажные и крепежные инструменты\Степлеры и антистеплеры строительные: 300 товаров
- Интерпретация: Существуют категории-листья с максимальным количеством товаров (300 единиц), что указывает на необходимость их разбиения на подкатегории для улучшения навигации.

## Выводы

В ходе выполнения лабораторной работы были достигнуты все поставленные цели:
1. Успешно развернута и настроена инфраструктура с MongoDB 7.x в Docker-контейнере.
2. Разработана и реализована схема хранения данных с учетом иерархической природы категорий.
3. Выполнена загрузка данных из Parquet файла и создание необходимых индексов.
4. Проведены базовые аналитические запросы к иерархическим данным.
5. Реализованы сложные агрегации для анализа структуры категорий и распределения товаров.

Особое внимание было уделено проектированию схемы данных и созданию индексов для оптимизации производительности. Использование двух коллекций (`categories` и `products`) с частичной денормализацией оказалось эффективным решением для баланса между нормализацией и производительностью.

Работа с агрегационным фреймворком показала высокую гибкость MongoDB в решении аналитических задач, таких как группировка и анализ иерархических структур.

## Заключение

Лабораторная работа выполнена в полном объеме. Были освоены ключевые аспекты работы с MongoDB: проектирование схемы, загрузка данных, создание индексов и выполнение аналитических запросов. Полученные навыки могут быть применены при разработке реальных приложений с иерархическими данными, таких как интернет-магазины, каталоги продукции и систем управления контентом.